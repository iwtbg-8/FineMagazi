import{minify,_default_options}from"../main.js";import{parse}from"./parse.js";import{AST_Assign,AST_Array,AST_Constant,AST_Node,AST_PropAccess,AST_RegExp,AST_Sequence,AST_Symbol,AST_Token,walk}from"./ast.js";import{OutputStream}from"./output.js";export async function run_cli({program:e,packageJson:n,fs:o,path:r}){const t=new Set(["cname","parent_scope","scope","uses_eval","uses_with"]);var a={},s={compress:!1,mangle:!1};const i=await _default_options();if(e.version(n.name+" "+n.version),e.parseArgv=e.parse,e.parse=void 0,process.argv.includes("ast")?e.helpInformation=function(){var e=OutputStream({beautify:!0});return function n(o){e.print("AST_"+o.TYPE);const r=o.SELF_PROPS.filter(e=>!/^\$/.test(e));r.length>0&&(e.space(),e.with_parens(function(){r.forEach(function(n,o){o&&e.space(),e.print(n)})}));o.documentation&&(e.space(),e.print_string(o.documentation));o.SUBCLASSES.length>0&&(e.space(),e.with_block(function(){o.SUBCLASSES.forEach(function(o){e.indent(),n(o),e.newline()})}))}(AST_Node),e+"\n"}:process.argv.includes("options")&&(e.helpInformation=function(){var e=[];for(var n in i)e.push("--"+("sourceMap"===n?"source-map":n)+" options:"),e.push(S(i[n])),e.push("");return e.join("\n")}),e.option("-p, --parse <options>","Specify parser options.",d()),e.option("-c, --compress [options]","Enable compressor/specify compressor options.",d()),e.option("-m, --mangle [options]","Mangle names/specify mangler options.",d()),e.option("--mangle-props [options]","Mangle properties/specify mangler options.",d()),e.option("-f, --format [options]","Format options.",d()),e.option("-b, --beautify [options]","Alias for --format.",d()),e.option("-o, --output <file>","Output file (default STDOUT)."),e.option("--comments [filter]","Preserve copyright comments in the output."),e.option("--config-file <file>","Read minify() options from JSON file."),e.option("-d, --define <expr>[=value]","Global definitions.",d("define")),e.option("--ecma <version>","Specify ECMAScript release: 5, 2015, 2016 or 2017..."),e.option("-e, --enclose [arg[,...][:value[,...]]]","Embed output in a big function with configurable arguments and values."),e.option("--ie8","Support non-standard Internet Explorer 8."),e.option("--keep-classnames","Do not mangle/drop class names."),e.option("--keep-fnames","Do not mangle/drop function names. Useful for code relying on Function.prototype.name."),e.option("--module","Input is an ES6 module"),e.option("--name-cache <file>","File to hold mangled name mappings."),e.option("--rename","Force symbol expansion."),e.option("--no-rename","Disable symbol expansion."),e.option("--safari10","Support non-standard Safari 10."),e.option("--source-map [options]","Enable source map/specify source map options.",d()),e.option("--timings","Display operations run time on STDERR."),e.option("--toplevel","Compress and/or mangle variables in toplevel scope."),e.option("--wrap <name>","Embed everything as a function with “exports” corresponding to “name” globally."),e.arguments("[files...]").parseArgv(process.argv),e.configFile&&(s=JSON.parse(g(e.configFile))),!e.output&&e.sourceMap&&"inline"!=e.sourceMap.url&&f("ERROR: cannot write source map to STDOUT"),["compress","enclose","ie8","mangle","module","safari10","sourceMap","toplevel","wrap"].forEach(function(n){n in e&&(s[n]=e[n])}),"ecma"in e){e.ecma!=(0|e.ecma)&&f("ERROR: ecma must be an integer");const n=0|e.ecma;s.ecma=n>5&&n<2015?n+2009:n}if(e.format||e.beautify){const n=e.format||e.beautify;s.format="object"==typeof n?n:{}}if(e.comments&&("object"!=typeof s.format&&(s.format={}),s.format.comments="string"==typeof e.comments?"false"!=e.comments&&e.comments:"some"),e.define)for(var p in"object"!=typeof s.compress&&(s.compress={}),"object"!=typeof s.compress.global_defs&&(s.compress.global_defs={}),e.define)s.compress.global_defs[p]=e.define[p];e.keepClassnames&&(s.keep_classnames=!0),e.keepFnames&&(s.keep_fnames=!0),e.mangleProps&&(e.mangleProps.domprops?delete e.mangleProps.domprops:("object"!=typeof e.mangleProps&&(e.mangleProps={}),Array.isArray(e.mangleProps.reserved)||(e.mangleProps.reserved=[])),"object"!=typeof s.mangle&&(s.mangle={}),s.mangle.properties=e.mangleProps),e.nameCache&&(s.nameCache=JSON.parse(g(e.nameCache,"{}"))),"ast"==e.output&&(s.format={ast:!0,code:!1}),e.parse&&(e.parse.acorn||e.parse.spidermonkey?e.sourceMap&&"inline"==e.sourceMap.content&&f("ERROR: inline source map only works with built-in parser"):s.parse=e.parse),~e.rawArgs.indexOf("--rename")?s.rename=!0:e.rename||(s.rename=!1);let c=e=>e;var l;let m;function u(e){return AST_Node.from_mozilla_ast(Object.keys(a).reduce(e,null))}function f(e){e instanceof Error&&(e=e.stack.replace(/^\S*?Error:/,"ERROR:")),_(e),process.exit(1)}function g(e,n){try{return o.readFileSync(e,"utf8")}catch(e){if(("ENOENT"==e.code||"ENAMETOOLONG"==e.code)&&null!=n)return n;f(e)}}function d(e){return function(n,o){o=o||{};try{walk(parse(n,{expression:!0}),n=>{if(n instanceof AST_Assign){var r=n.left.print_to_string(),t=n.right;return e?o[r]=t:t instanceof AST_Array?o[r]=t.elements.map(a):t instanceof AST_RegExp?(t=t.value,o[r]=new RegExp(t.source,t.flags)):o[r]=a(t),!0}if(n instanceof AST_Symbol||n instanceof AST_PropAccess){r=n.print_to_string();return o[r]=!0,!0}if(!(n instanceof AST_Sequence))throw n;function a(e){return e instanceof AST_Constant?e.getValue():e.print_to_string({quote_keys:!0})}})}catch(r){e?f("Error parsing arguments for '"+e+"': "+n):o[n]=null}return o}}function y(e){var n=1e6+e.id+" "+e.name;return e.mangled_name&&(n+=" "+e.mangled_name),n}function S(e){var n=[],o="";return Object.keys(e).map(function(n){return o.length<n.length&&(o=Array(n.length+1).join(" ")),[n,JSON.stringify(e[n])]}).forEach(function(e){n.push("  "+e[0]+o.slice(e[0].length-2)+e[1])}),n.join("\n")}function _(e){process.stderr.write(e),process.stderr.write("\n")}"object"==typeof e.sourceMap&&"base"in e.sourceMap&&(l=e.sourceMap.base,delete s.sourceMap.base,c=function(e){return r.relative(l,e)}),s.files&&s.files.length?(m=s.files,delete s.files):e.args.length&&(m=e.args),m?function e(n){if(Array.isArray(n))return[].concat.apply([],n.map(e));if(n&&n.match(/[*?]/)){var t=r.dirname(n);try{var a=o.readdirSync(t)}catch(e){}if(a){var s="^"+r.basename(n).replace(/[.+^$[\]\\(){}]/g,"\\$&").replace(/\*/g,"[^/\\\\]*").replace(/\?/g,"[^/\\\\]")+"$",i="win32"===process.platform?"i":"",p=new RegExp(s,i),c=a.filter(function(e){return p.test(e)}).map(function(e){return r.join(t,e)});if(c.length)return c}}return[n]}(m).forEach(function(e){a[c(e)]=g(e)}):await new Promise(e=>{var n=[];process.stdin.setEncoding("utf8"),process.stdin.on("data",function(e){n.push(e)}).on("end",function(){a=[n.join("")],e()}),process.stdin.resume()}),await async function(){var n=e.sourceMap&&e.sourceMap.content;n&&"inline"!==n&&(s.sourceMap.content=g(n,n));e.timings&&(s.timings=!0);try{e.parse&&(e.parse.acorn?a=u(function(n,o){return require("acorn").parse(a[o],{ecmaVersion:2024,locations:!0,program:n,sourceFile:o,sourceType:s.module||e.parse.module?"module":"script"})}):e.parse.spidermonkey&&(a=u(function(e,n){var o=JSON.parse(a[n]);return e?(e.body=e.body.concat(o.body),e):o})))}catch(e){f(e)}let i;try{i=await minify(a,s,o)}catch(e){if("SyntaxError"==e.name){_("Parse error at "+e.filename+":"+e.line+","+e.col);var p=e.col,c=a[e.filename].split(/\r?\n/),l=c[e.line-1];if(l||p||(p=(l=c[e.line-2]).length),l){p>70&&(l=l.slice(p-70),p=70),_(l.slice(0,80)),_(l.slice(0,p).replace(/\S/g," ")+"^")}}return e.defs&&(_("Supported options:"),_(S(e.defs))),void f(e)}if("ast"==e.output)s.compress||s.mangle||i.ast.figure_out_scope({}),console.log(JSON.stringify(i.ast,function(e,n){if(n)switch(e){case"thedef":return y(n);case"enclosed":return n.length?n.map(y):void 0;case"variables":case"globals":return n.size?function(e,n){var o=[];return e.forEach(function(e){o.push(n(e))}),o}(n,y):void 0}if(!t.has(e)&&!(n instanceof AST_Token||n instanceof Map)){if(n instanceof AST_Node){var o={_class:"AST_"+n.TYPE};return n.block_scope&&(o.variables=n.block_scope.variables,o.enclosed=n.block_scope.enclosed),n.CTOR.PROPS.forEach(function(e){"block_scope"!==e&&(o[e]=n[e])}),o}return n}},2));else if("spidermonkey"==e.output)try{const e=await minify(i.code,{compress:!1,mangle:!1,format:{ast:!0,code:!1}},o);console.log(JSON.stringify(e.ast.to_mozilla_ast(),null,2))}catch(e){return void f(e)}else e.output?(o.mkdirSync(r.dirname(e.output),{recursive:!0}),o.writeFileSync(e.output,i.code),s.sourceMap&&"inline"!==s.sourceMap.url&&i.map&&o.writeFileSync(e.output+".map",i.map)):console.log(i.code);e.nameCache&&o.writeFileSync(e.nameCache,JSON.stringify(s.nameCache));if(i.timings)for(var m in i.timings)_("- "+m+": "+i.timings[m].toFixed(3)+"s")}()}