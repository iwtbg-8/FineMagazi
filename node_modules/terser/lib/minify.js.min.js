"use strict";import{defaults,map_from_object,map_to_object,HOP}from"./utils/index.js";import{AST_Toplevel,AST_Node,walk,AST_Scope}from"./ast.js";import{parse}from"./parse.js";import{OutputStream}from"./output.js";import{Compressor}from"./compress/index.js";import{base54}from"./scope.js";import{SourceMap}from"./sourcemap.js";import{mangle_properties,mangle_private_properties,reserve_quoted_keys,find_annotated_props}from"./propmangle.js";var to_ascii="undefined"!=typeof Buffer?e=>Buffer.from(e,"base64").toString():e=>decodeURIComponent(escape(atob(e))),to_base64="undefined"!=typeof Buffer?e=>Buffer.from(e).toString("base64"):e=>btoa(unescape(encodeURIComponent(e)));function read_source_map(e){var o=/(?:^|[^.])\/\/# sourceMappingURL=data:application\/json(;[\w=-]*)?;base64,([+/0-9A-Za-z]*=*)\s*$/.exec(e);return o?to_ascii(o[2]):(console.warn("inline source map not found"),null)}function set_shorthand(e,o,r){o[e]&&r.forEach(function(r){o[r]&&("object"!=typeof o[r]&&(o[r]={}),e in o[r]||(o[r][e]=o[e]))})}function init_cache(e){e&&("props"in e?e.props instanceof Map||(e.props=map_from_object(e.props)):e.props=new Map)}function cache_to_json(e){return{props:map_to_object(e.props)}}function log_input(e,o,r,a){if(!(r&&r.writeFileSync&&r.mkdirSync))return;try{r.mkdirSync(a)}catch(e){if("EEXIST"!==e.code)throw e}const n=`${a}/terser-debug-${9999999*Math.random()|0}.log`;o=o||{};const s=JSON.stringify(o,(e,o)=>"function"==typeof o?"[Function "+o.toString()+"]":o instanceof RegExp?"[RegExp "+o.toString()+"]":o,4),t=e=>"object"==typeof e&&o.parse&&o.parse.spidermonkey?JSON.stringify(e,null,2):"object"==typeof e?Object.keys(e).map(o=>o+": "+t(e[o])).join("\n\n"):"string"==typeof e?"```\n"+e+"\n```":e;r.writeFileSync(n,"Options: \n"+s+"\n\nInput files:\n\n"+t(e)+"\n")}function*minify_sync_or_async(e,o,r){r&&"object"==typeof process&&process.env&&"string"==typeof process.env.TERSER_DEBUG_DIR&&log_input(e,o,r,process.env.TERSER_DEBUG_DIR);var a,n,s,t=(o=defaults(o,{compress:{},ecma:void 0,enclose:!1,ie8:!1,keep_classnames:void 0,keep_fnames:!1,mangle:{},module:!1,nameCache:null,output:null,format:null,parse:{},rename:void 0,safari10:!1,sourceMap:!1,spidermonkey:!1,timings:!1,toplevel:!1,warnings:!1,wrap:!1},!0)).timings&&{start:Date.now()};if(void 0===o.keep_classnames&&(o.keep_classnames=o.keep_fnames),void 0===o.rename&&(o.rename=o.compress&&o.mangle),o.output&&o.format)throw new Error("Please only specify either output or format option, preferrably format.");if(o.format=o.format||o.output||{},set_shorthand("ecma",o,["parse","compress","format"]),set_shorthand("ie8",o,["compress","mangle","format"]),set_shorthand("keep_classnames",o,["compress","mangle"]),set_shorthand("keep_fnames",o,["compress","mangle"]),set_shorthand("module",o,["parse","compress","mangle"]),set_shorthand("safari10",o,["mangle","format"]),set_shorthand("toplevel",o,["compress","mangle"]),set_shorthand("warnings",o,["compress"]),o.mangle&&(o.mangle=defaults(o.mangle,{cache:o.nameCache&&(o.nameCache.vars||{}),eval:!1,ie8:!1,keep_classnames:!1,keep_fnames:!1,module:!1,nth_identifier:base54,properties:!1,reserved:[],safari10:!1,toplevel:!1},!0),o.mangle.properties&&("object"!=typeof o.mangle.properties&&(o.mangle.properties={}),o.mangle.properties.keep_quoted&&(a=o.mangle.properties.reserved,Array.isArray(a)||(a=[]),o.mangle.properties.reserved=a),o.nameCache&&!("cache"in o.mangle.properties)&&(o.mangle.properties.cache=o.nameCache.props||{})),init_cache(o.mangle.cache),init_cache(o.mangle.properties.cache)),o.sourceMap&&(o.sourceMap=defaults(o.sourceMap,{asObject:!1,content:null,filename:null,includeSources:!1,root:null,url:null},!0)),t&&(t.parse=Date.now()),e instanceof AST_Toplevel)n=e;else{if(("string"==typeof e||o.parse.spidermonkey&&!Array.isArray(e))&&(e=[e]),o.parse=o.parse||{},o.parse.toplevel=null,o.parse.spidermonkey)o.parse.toplevel=AST_Node.from_mozilla_ast(Object.keys(e).reduce(function(o,r){return o?(o.body=o.body.concat(e[r].body),o):e[r]},null));else for(var p in delete o.parse.spidermonkey,e)if(HOP(e,p)&&(o.parse.filename=p,o.parse.toplevel=parse(e[p],o.parse),o.sourceMap&&"inline"==o.sourceMap.content)){if(Object.keys(e).length>1)throw new Error("inline source map only works with singular input");o.sourceMap.content=read_source_map(e[p])}if(null===o.parse.toplevel)throw new Error("no source file given");n=o.parse.toplevel}a&&"strict"!==o.mangle.properties.keep_quoted&&reserve_quoted_keys(n,a),o.mangle&&o.mangle.properties&&(s=find_annotated_props(n)),o.wrap&&(n=n.wrap_commonjs(o.wrap)),o.enclose&&(n=n.wrap_enclose(o.enclose)),t&&(t.rename=Date.now()),t&&(t.compress=Date.now()),o.compress&&(n=new Compressor(o.compress,{mangle_options:o.mangle}).compress(n)),t&&(t.scope=Date.now()),o.mangle&&n.figure_out_scope(o.mangle),t&&(t.mangle=Date.now()),o.mangle&&(n.compute_char_frequency(o.mangle),n.mangle_names(o.mangle),n=mangle_private_properties(n,o.mangle)),t&&(t.properties=Date.now()),o.mangle&&o.mangle.properties&&(n=mangle_properties(n,o.mangle.properties,s)),t&&(t.format=Date.now());var c={};let i;if(o.format.ast&&(c.ast=n),o.format.spidermonkey&&(c.ast=n.to_mozilla_ast()),!HOP(o.format,"code")||o.format.code){if(i={...o.format},i.ast||(i._destroy_ast=!0,walk(n,e=>{e instanceof AST_Scope&&(e.variables=void 0,e.enclosed=void 0,e.parent_scope=void 0),e.block_scope&&(e.block_scope.variables=void 0,e.block_scope.enclosed=void 0,e.block_scope.parent_scope=void 0)})),o.sourceMap){if(o.sourceMap.includeSources&&e instanceof AST_Toplevel)throw new Error("original source content unavailable");i.source_map=yield*SourceMap({file:o.sourceMap.filename,orig:o.sourceMap.content,root:o.sourceMap.root,files:o.sourceMap.includeSources?e:null})}delete i.ast,delete i.code,delete i.spidermonkey;var m=OutputStream(i);if(n.print(m),c.code=m.get(),o.sourceMap)if(Object.defineProperty(c,"map",{configurable:!0,enumerable:!0,get(){const e=i.source_map.getEncoded();return c.map=o.sourceMap.asObject?e:JSON.stringify(e)},set(e){Object.defineProperty(c,"map",{value:e,writable:!0})}}),c.decoded_map=i.source_map.getDecoded(),"inline"==o.sourceMap.url){var l="object"==typeof c.map?JSON.stringify(c.map):c.map;c.code+="\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,"+to_base64(l)}else o.sourceMap.url&&(c.code+="\n//# sourceMappingURL="+o.sourceMap.url)}return o.nameCache&&o.mangle&&(o.mangle.cache&&(o.nameCache.vars=cache_to_json(o.mangle.cache)),o.mangle.properties&&o.mangle.properties.cache&&(o.nameCache.props=cache_to_json(o.mangle.properties.cache))),i&&i.source_map&&i.source_map.destroy(),t&&(t.end=Date.now(),c.timings={parse:.001*(t.rename-t.parse),rename:.001*(t.compress-t.rename),compress:.001*(t.scope-t.compress),scope:.001*(t.mangle-t.scope),mangle:.001*(t.properties-t.mangle),properties:.001*(t.format-t.properties),format:.001*(t.end-t.format),total:.001*(t.end-t.start)}),c}async function minify(e,o,r){const a=minify_sync_or_async(e,o,r);let n,s;do{s=a.next(await n),n=s.value}while(!s.done);return s.value}function minify_sync(e,o,r){const a=minify_sync_or_async(e,o,r);let n,s;do{if(n&&"function"==typeof n.then)throw new Error("minify_sync cannot be used with the legacy source-map module");s=a.next(n),n=s.value}while(!s.done);return s.value}export{minify,minify_sync,to_ascii};