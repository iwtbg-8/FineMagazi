import{AST_Accessor,AST_Array,AST_Arrow,AST_Assign,AST_Binary,AST_Call,AST_Chain,AST_Class,AST_ClassPrivateProperty,AST_ClassProperty,AST_ClassStaticBlock,AST_ConciseMethod,AST_Conditional,AST_Constant,AST_DefClass,AST_Dot,AST_Expansion,AST_Function,AST_Node,AST_Number,AST_Object,AST_ObjectGetter,AST_ObjectKeyVal,AST_ObjectSetter,AST_PrivateGetter,AST_PrivateSetter,AST_PrivateMethod,AST_PropAccess,AST_Scope,AST_Sequence,AST_SimpleStatement,AST_Sub,AST_SymbolRef,AST_TemplateSegment,AST_TemplateString,AST_This,AST_Unary}from"../ast.js";import{make_node,return_null,return_this}from"../utils/index.js";import{first_in_statement}from"../utils/first_in_statement.js";import{pure_prop_access_globals}from"./native-objects.js";import{lazy_op,unary_side_effects,is_nullish_shortcircuited}from"./inference.js";import{WRITE_ONLY,set_flag,clear_flag}from"./compressor-flags.js";import{make_sequence,is_func_expr,is_iife_call}from"./common.js";function def_drop_side_effect_free(e,t){for(const r of[].concat(e))r.DEFMETHOD("drop_side_effect_free",t)}function trim(e,t,r){var s=e.length;if(!s)return null;for(var i=[],_=!1,f=0;f<s;f++){var n=e[f].drop_side_effect_free(t,r);_|=n!==e[f],n&&(i.push(n),r=!1)}return _?i.length?i:null:e}def_drop_side_effect_free(AST_Node,return_this),def_drop_side_effect_free(AST_Constant,return_null),def_drop_side_effect_free(AST_This,return_null),def_drop_side_effect_free(AST_Call,function(e,t){if(is_nullish_shortcircuited(this,e))return this.expression.drop_side_effect_free(e,t);if(!this.is_callee_pure(e)){if(this.expression.is_call_pure(e)){var r=this.args.slice();return r.unshift(this.expression.expression),(r=trim(r,e,t))&&make_sequence(this,r)}if(is_func_expr(this.expression)&&(!this.expression.name||!this.expression.name.definition().references.length)){var s=this.clone();return s.expression.process_expression(!1,e),s}return this}var i=trim(this.args,e,t);return i&&make_sequence(this,i)}),def_drop_side_effect_free(AST_Accessor,return_null),def_drop_side_effect_free(AST_Function,return_null),def_drop_side_effect_free(AST_Arrow,return_null),def_drop_side_effect_free(AST_Class,function(e){const t=[];if(this.is_self_referential()&&this.has_side_effects(e))return this;const r=this.extends&&this.extends.drop_side_effect_free(e);r&&t.push(r);for(const r of this.properties)if(r instanceof AST_ClassStaticBlock){if(r.has_side_effects(e))return this}else{const s=r.drop_side_effect_free(e);s&&t.push(s)}if(!t.length)return null;const s=make_sequence(this,t);return this instanceof AST_DefClass?make_node(AST_SimpleStatement,this,{body:s}):s}),def_drop_side_effect_free([AST_ClassProperty,AST_ClassPrivateProperty],function(e){const t=this.computed_key()&&this.key.drop_side_effect_free(e),r=this.static&&this.value&&this.value.drop_side_effect_free(e);return t&&r?make_sequence(this,[t,r]):t||r||null}),def_drop_side_effect_free(AST_Binary,function(e,t){var r=this.right.drop_side_effect_free(e);if(!r)return this.left.drop_side_effect_free(e,t);if(lazy_op.has(this.operator)){if(r===this.right)return this;var s=this.clone();return s.right=r,s}var i=this.left.drop_side_effect_free(e,t);return i?make_sequence(this,[i,r]):this.right.drop_side_effect_free(e,t)}),def_drop_side_effect_free(AST_Assign,function(e){if(this.logical)return this;var t=this.left;if(t.has_side_effects(e)||e.has_directive("use strict")&&t instanceof AST_PropAccess&&t.expression.is_constant())return this;for(set_flag(this,WRITE_ONLY);t instanceof AST_PropAccess;)t=t.expression;return t.is_constant_expression(e.find_parent(AST_Scope))?this.right.drop_side_effect_free(e):this}),def_drop_side_effect_free(AST_Conditional,function(e){var t=this.consequent.drop_side_effect_free(e),r=this.alternative.drop_side_effect_free(e);if(t===this.consequent&&r===this.alternative)return this;if(!t)return r?make_node(AST_Binary,this,{operator:"||",left:this.condition,right:r}):this.condition.drop_side_effect_free(e);if(!r)return make_node(AST_Binary,this,{operator:"&&",left:this.condition,right:t});var s=this.clone();return s.consequent=t,s.alternative=r,s}),def_drop_side_effect_free(AST_Unary,function(e,t){if(unary_side_effects.has(this.operator))return this.expression.has_side_effects(e)?clear_flag(this,WRITE_ONLY):set_flag(this,WRITE_ONLY),this;if("typeof"==this.operator&&this.expression instanceof AST_SymbolRef)return null;var r=this.expression.drop_side_effect_free(e,t);return t&&r&&is_iife_call(r)?r===this.expression&&"!"==this.operator?this:r.negate(e,t):r}),def_drop_side_effect_free(AST_SymbolRef,function(e){return this.is_declared(e)||pure_prop_access_globals.has(this.name)?null:this}),def_drop_side_effect_free(AST_Object,function(e,t){var r=trim(this.properties,e,t);return r&&make_sequence(this,r)}),def_drop_side_effect_free(AST_ObjectKeyVal,function(e,t){const r=this.key instanceof AST_Node&&this.key.drop_side_effect_free(e,t),s=this.value.drop_side_effect_free(e,t);return r&&s?make_sequence(this,[r,s]):r||s}),def_drop_side_effect_free([AST_ConciseMethod,AST_ObjectGetter,AST_ObjectSetter],function(){return this.computed_key()?this.key:null}),def_drop_side_effect_free([AST_PrivateMethod,AST_PrivateGetter,AST_PrivateSetter],function(){return null}),def_drop_side_effect_free(AST_Array,function(e,t){var r=trim(this.elements,e,t);return r&&make_sequence(this,r)}),def_drop_side_effect_free(AST_Dot,function(e,t){return is_nullish_shortcircuited(this,e)?this.expression.drop_side_effect_free(e,t):!this.optional&&this.expression.may_throw_on_access(e)?this:this.expression.drop_side_effect_free(e,t)}),def_drop_side_effect_free(AST_Sub,function(e,t){if(is_nullish_shortcircuited(this,e))return this.expression.drop_side_effect_free(e,t);if(!this.optional&&this.expression.may_throw_on_access(e))return this;var r=this.property.drop_side_effect_free(e);if(r&&this.optional)return this;var s=this.expression.drop_side_effect_free(e,t);return s&&r?make_sequence(this,[s,r]):s||r}),def_drop_side_effect_free(AST_Chain,function(e,t){return this.expression.drop_side_effect_free(e,t)}),def_drop_side_effect_free(AST_Sequence,function(e){var t=this.tail_node(),r=t.drop_side_effect_free(e);if(r===t)return this;var s=this.expressions.slice(0,-1);return r&&s.push(r),s.length?make_sequence(this,s):make_node(AST_Number,this,{value:0})}),def_drop_side_effect_free(AST_Expansion,function(e,t){return this.expression.drop_side_effect_free(e,t)}),def_drop_side_effect_free(AST_TemplateSegment,return_null),def_drop_side_effect_free(AST_TemplateString,function(e){var t=trim(this.segments,e,first_in_statement);return t&&make_sequence(this,t)});