import{AST_Array,AST_Arrow,AST_Assign,AST_BigInt,AST_Binary,AST_Block,AST_BlockStatement,AST_Call,AST_Case,AST_Chain,AST_Class,AST_DefClass,AST_ClassStaticBlock,AST_ClassPrivateProperty,AST_ClassProperty,AST_ConciseMethod,AST_Conditional,AST_Constant,AST_Definitions,AST_Dot,AST_EmptyStatement,AST_Expansion,AST_False,AST_ForIn,AST_Function,AST_If,AST_Import,AST_ImportMeta,AST_Jump,AST_LabeledStatement,AST_Lambda,AST_New,AST_Node,AST_Null,AST_Number,AST_Object,AST_ObjectGetter,AST_ObjectKeyVal,AST_ObjectProperty,AST_ObjectSetter,AST_PrivateGetter,AST_PrivateMethod,AST_PrivateSetter,AST_PropAccess,AST_RegExp,AST_Return,AST_Scope,AST_Sequence,AST_SimpleStatement,AST_Statement,AST_String,AST_Sub,AST_Switch,AST_SwitchBranch,AST_SymbolClassProperty,AST_SymbolDeclaration,AST_SymbolRef,AST_TemplateSegment,AST_TemplateString,AST_This,AST_True,AST_Try,AST_Unary,AST_UnaryPostfix,AST_UnaryPrefix,AST_Undefined,AST_VarDef,walk,walk_abort,_PURE}from"../ast.js";import{makePredicate,return_true,return_false,return_null,return_this,make_node,member,has_annotation}from"../utils/index.js";import{make_sequence,best_of_expression,read_property,requires_sequence_to_maintain_binding}from"./common.js";import{INLINED,UNDEFINED,has_flag}from"./compressor-flags.js";import{pure_prop_access_globals,is_pure_native_fn,is_pure_native_method}from"./native-objects.js";export const is_undeclared_ref=t=>t instanceof AST_SymbolRef&&t.definition().undeclared;export const bitwise_binop=makePredicate("<<< >> << & | ^ ~");export const lazy_op=makePredicate("&& || ??");export const unary_side_effects=makePredicate("delete ++ --");!function(t){const e=makePredicate("! delete"),n=makePredicate("in instanceof == != === !== < <= >= >");t(AST_Node,return_false),t(AST_UnaryPrefix,function(){return e.has(this.operator)}),t(AST_Binary,function(){return n.has(this.operator)||lazy_op.has(this.operator)&&this.left.is_boolean()&&this.right.is_boolean()}),t(AST_Conditional,function(){return this.consequent.is_boolean()&&this.alternative.is_boolean()}),t(AST_Assign,function(){return"="==this.operator&&this.right.is_boolean()}),t(AST_Sequence,function(){return this.tail_node().is_boolean()}),t(AST_True,return_true),t(AST_False,return_true)}(function(t,e){t.DEFMETHOD("is_boolean",e)}),function(t){t(AST_Node,return_false),t(AST_Number,return_true);const e=makePredicate("+ - ~ ++ --");t(AST_Unary,function(t){return e.has(this.operator)&&this.expression.is_number(t)});const n=makePredicate("- * / % & | ^ << >> >>>");t(AST_Binary,function(t){return"+"===this.operator?this.left.is_number(t)&&this.right.is_number_or_bigint(t)||this.right.is_number(t)&&this.left.is_number_or_bigint(t):!!n.has(this.operator)&&(this.left.is_number(t)||this.right.is_number(t))}),t(AST_Assign,function(t){return("="===this.operator||n.has(this.operator.slice(0,-1)))&&this.right.is_number(t)}),t(AST_Sequence,function(t){return this.tail_node().is_number(t)}),t(AST_Conditional,function(t){return this.consequent.is_number(t)&&this.alternative.is_number(t)})}(function(t,e){t.DEFMETHOD("is_number",e)}),function(t){t(AST_Node,return_false),t(AST_BigInt,return_true);const e=makePredicate("+ - ~ ++ --");t(AST_Unary,function(t){return e.has(this.operator)&&this.expression.is_bigint(t)});const n=makePredicate("- * / % & | ^ << >>");t(AST_Binary,function(t){return"+"===this.operator?this.left.is_bigint(t)&&this.right.is_number_or_bigint(t)||this.right.is_bigint(t)&&this.left.is_number_or_bigint(t):!!n.has(this.operator)&&(this.left.is_bigint(t)||this.right.is_bigint(t))}),t(AST_Assign,function(t){return(n.has(this.operator.slice(0,-1))||"="==this.operator)&&this.right.is_bigint(t)}),t(AST_Sequence,function(t){return this.tail_node().is_bigint(t)}),t(AST_Conditional,function(t){return this.consequent.is_bigint(t)&&this.alternative.is_bigint(t)})}(function(t,e){t.DEFMETHOD("is_bigint",e)}),function(t){t(AST_Node,return_false),t(AST_Number,return_true),t(AST_BigInt,return_true);const e=makePredicate("+ - ~ ++ --");t(AST_Unary,function(t){return e.has(this.operator)});const n=makePredicate("- * / % & | ^ << >>");t(AST_Binary,function(t){return"+"===this.operator?this.left.is_number_or_bigint(t)&&this.right.is_number_or_bigint(t):n.has(this.operator)}),t(AST_Assign,function(t){return n.has(this.operator.slice(0,-1))||"="==this.operator&&this.right.is_number_or_bigint(t)}),t(AST_Sequence,function(t){return this.tail_node().is_number_or_bigint(t)}),t(AST_Conditional,function(t){return this.consequent.is_number_or_bigint(t)&&this.alternative.is_number_or_bigint(t)})}(function(t,e){t.DEFMETHOD("is_number_or_bigint",e)}),function(t){t(AST_Node,return_false),t(AST_Number,function(t){return this.value===(0|this.value)}),t(AST_UnaryPrefix,function(t){return"~"==this.operator?this.expression.is_number(t):"+"===this.operator&&this.expression.is_32_bit_integer(t)}),t(AST_Binary,function(t){return bitwise_binop.has(this.operator)&&(this.left.is_number(t)||this.right.is_number(t))})}(function(t,e){t.DEFMETHOD("is_32_bit_integer",e)}),function(t){t(AST_Node,return_false),t(AST_String,return_true),t(AST_TemplateString,return_true),t(AST_UnaryPrefix,function(){return"typeof"==this.operator}),t(AST_Binary,function(t){return"+"==this.operator&&(this.left.is_string(t)||this.right.is_string(t))}),t(AST_Assign,function(t){return("="==this.operator||"+="==this.operator)&&this.right.is_string(t)}),t(AST_Sequence,function(t){return this.tail_node().is_string(t)}),t(AST_Conditional,function(t){return this.consequent.is_string(t)&&this.alternative.is_string(t)})}(function(t,e){t.DEFMETHOD("is_string",e)});export function is_undefined(t,e){return has_flag(t,UNDEFINED)||t instanceof AST_Undefined||t instanceof AST_UnaryPrefix&&"void"==t.operator&&!t.expression.has_side_effects(e)}function is_null_or_undefined(t,e){let n;return t instanceof AST_Null||is_undefined(t,e)||t instanceof AST_SymbolRef&&(n=t.definition().fixed)instanceof AST_Node&&is_nullish(n,e)}export function is_nullish_shortcircuited(t,e){return t instanceof AST_PropAccess||t instanceof AST_Call?t.optional&&is_null_or_undefined(t.expression,e)||is_nullish_shortcircuited(t.expression,e):t instanceof AST_Chain&&is_nullish_shortcircuited(t.expression,e)}export function is_nullish(t,e){return!!is_null_or_undefined(t,e)||is_nullish_shortcircuited(t,e)}!function(t){function e(t,e){for(var n=t.length;--n>=0;)if(t[n].has_side_effects(e))return!0;return!1}t(AST_Node,return_true),t(AST_EmptyStatement,return_false),t(AST_Constant,return_false),t(AST_This,return_false),t(AST_Block,function(t){return e(this.body,t)}),t(AST_Call,function(t){return!(this.is_callee_pure(t)||this.expression.is_call_pure(t)&&!this.expression.has_side_effects(t))||e(this.args,t)}),t(AST_Switch,function(t){return this.expression.has_side_effects(t)||e(this.body,t)}),t(AST_Case,function(t){return this.expression.has_side_effects(t)||e(this.body,t)}),t(AST_Try,function(t){return this.body.has_side_effects(t)||this.bcatch&&this.bcatch.has_side_effects(t)||this.bfinally&&this.bfinally.has_side_effects(t)}),t(AST_If,function(t){return this.condition.has_side_effects(t)||this.body&&this.body.has_side_effects(t)||this.alternative&&this.alternative.has_side_effects(t)}),t(AST_ImportMeta,return_false),t(AST_LabeledStatement,function(t){return this.body.has_side_effects(t)}),t(AST_SimpleStatement,function(t){return this.body.has_side_effects(t)}),t(AST_Lambda,return_false),t(AST_Class,function(t){return!(!this.extends||!this.extends.has_side_effects(t))||e(this.properties,t)}),t(AST_ClassStaticBlock,function(t){return e(this.body,t)}),t(AST_Binary,function(t){return this.left.has_side_effects(t)||this.right.has_side_effects(t)}),t(AST_Assign,return_true),t(AST_Conditional,function(t){return this.condition.has_side_effects(t)||this.consequent.has_side_effects(t)||this.alternative.has_side_effects(t)}),t(AST_Unary,function(t){return unary_side_effects.has(this.operator)||this.expression.has_side_effects(t)}),t(AST_SymbolRef,function(t){return!this.is_declared(t)&&!pure_prop_access_globals.has(this.name)}),t(AST_SymbolClassProperty,return_false),t(AST_SymbolDeclaration,return_false),t(AST_Object,function(t){return e(this.properties,t)}),t(AST_ObjectKeyVal,function(t){return this.computed_key()&&this.key.has_side_effects(t)||this.value&&this.value.has_side_effects(t)}),t([AST_ClassProperty,AST_ClassPrivateProperty],function(t){return this.computed_key()&&this.key.has_side_effects(t)||this.static&&this.value&&this.value.has_side_effects(t)}),t([AST_PrivateMethod,AST_PrivateGetter,AST_PrivateSetter,AST_ConciseMethod,AST_ObjectGetter,AST_ObjectSetter],function(t){return this.computed_key()&&this.key.has_side_effects(t)}),t(AST_Array,function(t){return e(this.elements,t)}),t(AST_Dot,function(t){return is_nullish(this,t)?this.expression.has_side_effects(t):!(this.optional||!this.expression.may_throw_on_access(t))||this.expression.has_side_effects(t)}),t(AST_Sub,function(t){if(is_nullish(this,t))return this.expression.has_side_effects(t);if(!this.optional&&this.expression.may_throw_on_access(t))return!0;var e=this.property.has_side_effects(t);return!(!e||!this.optional)||(e||this.expression.has_side_effects(t))}),t(AST_Chain,function(t){return this.expression.has_side_effects(t)}),t(AST_Sequence,function(t){return e(this.expressions,t)}),t(AST_Definitions,function(t){return e(this.definitions,t)}),t(AST_VarDef,function(){return null!=this.value}),t(AST_TemplateSegment,return_false),t(AST_TemplateString,function(t){return e(this.segments,t)})}(function(t,e){for(const n of[].concat(t))n.DEFMETHOD("has_side_effects",e)}),function(t){function e(t,e){for(var n=t.length;--n>=0;)if(t[n].may_throw(e))return!0;return!1}t(AST_Node,return_true),t(AST_Constant,return_false),t(AST_EmptyStatement,return_false),t(AST_Lambda,return_false),t(AST_SymbolDeclaration,return_false),t(AST_This,return_false),t(AST_ImportMeta,return_false),t(AST_Class,function(t){return!(!this.extends||!this.extends.may_throw(t))||e(this.properties,t)}),t(AST_ClassStaticBlock,function(t){return e(this.body,t)}),t(AST_Array,function(t){return e(this.elements,t)}),t(AST_Assign,function(t){return!!this.right.may_throw(t)||!(!t.has_directive("use strict")&&"="==this.operator&&this.left instanceof AST_SymbolRef)&&this.left.may_throw(t)}),t(AST_Binary,function(t){return this.left.may_throw(t)||this.right.may_throw(t)}),t(AST_Block,function(t){return e(this.body,t)}),t(AST_Call,function(t){return!is_nullish(this,t)&&(!!e(this.args,t)||!this.is_callee_pure(t)&&(!!this.expression.may_throw(t)||(!(this.expression instanceof AST_Lambda)||e(this.expression.body,t))))}),t(AST_Case,function(t){return this.expression.may_throw(t)||e(this.body,t)}),t(AST_Conditional,function(t){return this.condition.may_throw(t)||this.consequent.may_throw(t)||this.alternative.may_throw(t)}),t(AST_Definitions,function(t){return e(this.definitions,t)}),t(AST_If,function(t){return this.condition.may_throw(t)||this.body&&this.body.may_throw(t)||this.alternative&&this.alternative.may_throw(t)}),t(AST_LabeledStatement,function(t){return this.body.may_throw(t)}),t(AST_Object,function(t){return e(this.properties,t)}),t(AST_ObjectKeyVal,function(t){return!!(this.computed_key()&&this.key.may_throw(t)||this.value)&&this.value.may_throw(t)}),t([AST_ClassProperty,AST_ClassPrivateProperty],function(t){return this.computed_key()&&this.key.may_throw(t)||this.static&&this.value&&this.value.may_throw(t)}),t([AST_ConciseMethod,AST_ObjectGetter,AST_ObjectSetter],function(t){return this.computed_key()&&this.key.may_throw(t)}),t([AST_PrivateMethod,AST_PrivateGetter,AST_PrivateSetter],return_false),t(AST_Return,function(t){return this.value&&this.value.may_throw(t)}),t(AST_Sequence,function(t){return e(this.expressions,t)}),t(AST_SimpleStatement,function(t){return this.body.may_throw(t)}),t(AST_Dot,function(t){return!is_nullish(this,t)&&(!this.optional&&this.expression.may_throw_on_access(t)||this.expression.may_throw(t))}),t(AST_Sub,function(t){return!is_nullish(this,t)&&(!this.optional&&this.expression.may_throw_on_access(t)||this.expression.may_throw(t)||this.property.may_throw(t))}),t(AST_Chain,function(t){return this.expression.may_throw(t)}),t(AST_Switch,function(t){return this.expression.may_throw(t)||e(this.body,t)}),t(AST_SymbolRef,function(t){return!this.is_declared(t)&&!pure_prop_access_globals.has(this.name)}),t(AST_SymbolClassProperty,return_false),t(AST_Try,function(t){return this.bcatch?this.bcatch.may_throw(t):this.body.may_throw(t)||this.bfinally&&this.bfinally.may_throw(t)}),t(AST_Unary,function(t){return!("typeof"==this.operator&&this.expression instanceof AST_SymbolRef)&&this.expression.may_throw(t)}),t(AST_VarDef,function(t){return!!this.value&&this.value.may_throw(t)})}(function(t,e){for(const n of[].concat(t))n.DEFMETHOD("may_throw",e)}),function(t){function e(t){let e=!0;return walk(this,n=>{if(n instanceof AST_SymbolRef){if(has_flag(this,INLINED))return e=!1,walk_abort;var r=n.definition();if(member(r,this.enclosed)&&!this.variables.has(r.name)){if(t){var i=t.find_variable(n);if(r.undeclared?!i:i===r)return e="f",!0}return e=!1,walk_abort}return!0}if(n instanceof AST_This&&this instanceof AST_Arrow)return e=!1,walk_abort}),e}t(AST_Node,return_false),t(AST_Constant,return_true),t(AST_Class,function(t){if(this.extends&&!this.extends.is_constant_expression(t))return!1;for(const e of this.properties){if(e.computed_key()&&!e.key.is_constant_expression(t))return!1;if(e.static&&e.value&&!e.value.is_constant_expression(t))return!1;if(e instanceof AST_ClassStaticBlock)return!1}return e.call(this,t)}),t(AST_Lambda,e),t(AST_Unary,function(){return this.expression.is_constant_expression()}),t(AST_Binary,function(){return this.left.is_constant_expression()&&this.right.is_constant_expression()}),t(AST_Array,function(){return this.elements.every(t=>t.is_constant_expression())}),t(AST_Object,function(){return this.properties.every(t=>t.is_constant_expression())}),t(AST_ObjectProperty,function(){return!(this.key instanceof AST_Node||!this.value||!this.value.is_constant_expression())})}(function(t,e){t.DEFMETHOD("is_constant_expression",e)}),function(t){function e(t){return/strict/.test(t.option("pure_getters"))}AST_Node.DEFMETHOD("may_throw_on_access",function(t){return!t.option("pure_getters")||this._dot_throw(t)}),t(AST_Node,e),t(AST_Null,return_true),t(AST_Undefined,return_true),t(AST_Constant,return_false),t(AST_Array,return_false),t(AST_Object,function(t){if(!e(t))return!1;for(var n=this.properties.length;--n>=0;)if(this.properties[n]._dot_throw(t))return!0;return!1}),t(AST_Class,return_false),t(AST_ObjectProperty,return_false),t(AST_ObjectGetter,return_true),t(AST_Expansion,function(t){return this.expression._dot_throw(t)}),t(AST_Function,return_false),t(AST_Arrow,return_false),t(AST_UnaryPostfix,return_false),t(AST_UnaryPrefix,function(){return"void"==this.operator}),t(AST_Binary,function(t){return("&&"==this.operator||"||"==this.operator||"??"==this.operator)&&(this.left._dot_throw(t)||this.right._dot_throw(t))}),t(AST_Assign,function(t){return!!this.logical||"="==this.operator&&this.right._dot_throw(t)}),t(AST_Conditional,function(t){return this.consequent._dot_throw(t)||this.alternative._dot_throw(t)}),t(AST_Dot,function(t){return!!e(t)&&("prototype"!=this.property||!(this.expression instanceof AST_Function||this.expression instanceof AST_Class))}),t(AST_Chain,function(t){return this.expression._dot_throw(t)}),t(AST_Sequence,function(t){return this.tail_node()._dot_throw(t)}),t(AST_SymbolRef,function(t){if("arguments"===this.name&&this.scope instanceof AST_Lambda)return!1;if(has_flag(this,UNDEFINED))return!0;if(!e(t))return!1;if(is_undeclared_ref(this)&&this.is_declared(t))return!1;if(this.is_immutable())return!1;var n=this.fixed_value();return!n||n._dot_throw(t)})}(function(t,e){t.DEFMETHOD("_dot_throw",e)});export function is_lhs(t,e){return e instanceof AST_Unary&&unary_side_effects.has(e.operator)?e.expression:e instanceof AST_Assign&&e.left===t||e instanceof AST_ForIn&&e.init===t?t:void 0}!function(t){function e(t){return make_node(AST_UnaryPrefix,t,{operator:"!",expression:t})}function n(t,n,r){var i=e(t);if(r){var s=make_node(AST_SimpleStatement,n,{body:n});return best_of_expression(i,s)===s?n:i}return best_of_expression(i,n)}t(AST_Node,function(){return e(this)}),t(AST_Statement,function(){throw new Error("Cannot negate a statement")}),t(AST_Function,function(){return e(this)}),t(AST_Class,function(){return e(this)}),t(AST_Arrow,function(){return e(this)}),t(AST_UnaryPrefix,function(){return"!"==this.operator?this.expression:e(this)}),t(AST_Sequence,function(t){var e=this.expressions.slice();return e.push(e.pop().negate(t)),make_sequence(this,e)}),t(AST_Conditional,function(t,e){var r=this.clone();return r.consequent=r.consequent.negate(t),r.alternative=r.alternative.negate(t),n(this,r,e)}),t(AST_Binary,function(t,r){var i=this.clone(),s=this.operator;if(t.option("unsafe_comps"))switch(s){case"<=":return i.operator=">",i;case"<":return i.operator=">=",i;case">=":return i.operator="<",i;case">":return i.operator="<=",i}switch(s){case"==":return i.operator="!=",i;case"!=":return i.operator="==",i;case"===":return i.operator="!==",i;case"!==":return i.operator="===",i;case"&&":return i.operator="||",i.left=i.left.negate(t,r),i.right=i.right.negate(t),n(this,i,r);case"||":return i.operator="&&",i.left=i.left.negate(t,r),i.right=i.right.negate(t),n(this,i,r)}return e(this)})}(function(t,e){t.DEFMETHOD("negate",function(t,n){return e.call(this,t,n)})}),function(t){function e(t){return make_node(AST_UnaryPrefix,t,{operator:"~",expression:t})}t(AST_Node,function(t){return e(this)}),t(AST_Number,function(t){const n=~this.value;return n.toString().length>this.value.toString().length?e(this):make_node(AST_Number,this,{value:n})}),t(AST_UnaryPrefix,function(t,n){return"~"==this.operator&&(this.expression.is_32_bit_integer(t)||(null!=n?n:t.in_32_bit_context()))?this.expression:e(this)})}(function(t,e){t.DEFMETHOD("bitwise_negate",e)});var global_pure_fns=makePredicate("Boolean decodeURI decodeURIComponent Date encodeURI encodeURIComponent Error escape EvalError isFinite isNaN Number Object parseFloat parseInt RangeError ReferenceError String SyntaxError TypeError unescape URIError");AST_Call.DEFMETHOD("is_callee_pure",function(t){if(t.option("unsafe")){var e=this.expression,n=this.args&&this.args[0]&&this.args[0].evaluate(t);if(e.expression&&"hasOwnProperty"===e.expression.name&&(null==n||n.thedef&&n.thedef.undeclared))return!1;if(is_undeclared_ref(e)&&global_pure_fns.has(e.name))return!0;if(e instanceof AST_Dot&&is_undeclared_ref(e.expression)&&is_pure_native_fn(e.expression.name,e.property))return!0}return!!(this instanceof AST_New&&t.option("pure_new"))||(!(!t.option("side_effects")||!has_annotation(this,_PURE))||!t.pure_funcs(this))}),AST_Node.DEFMETHOD("is_call_pure",return_false),AST_Dot.DEFMETHOD("is_call_pure",function(t){if(!t.option("unsafe"))return;const e=this.expression;let n;return e instanceof AST_Array?n="Array":e.is_boolean()?n="Boolean":e.is_number(t)?n="Number":e instanceof AST_RegExp?n="RegExp":e.is_string(t)?n="String":this.may_throw_on_access(t)||(n="Object"),null!=n&&is_pure_native_method(n,this.property)});export const aborts=t=>t&&t.aborts();!function(t){function e(){for(var t=0;t<this.body.length;t++)if(aborts(this.body[t]))return this.body[t];return null}t(AST_Statement,return_null),t(AST_Jump,return_this),t(AST_Import,return_null),t(AST_BlockStatement,e),t(AST_SwitchBranch,e),t(AST_DefClass,function(){for(const t of this.properties)if(t instanceof AST_ClassStaticBlock&&t.aborts())return t;return null}),t(AST_ClassStaticBlock,e),t(AST_If,function(){return this.alternative&&aborts(this.body)&&aborts(this.alternative)&&this})}(function(t,e){t.DEFMETHOD("aborts",e)}),AST_Node.DEFMETHOD("contains_this",function(){return walk(this,t=>t instanceof AST_This?walk_abort:t!==this&&t instanceof AST_Scope&&!(t instanceof AST_Arrow)||void 0)});export function is_modified(t,e,n,r,i,s){var o=e.parent(i),_=is_lhs(n,o);if(_)return _;if(!s&&o instanceof AST_Call&&o.expression===n&&!(r instanceof AST_Arrow)&&!(r instanceof AST_Class)&&!o.is_callee_pure(t)&&(!(r instanceof AST_Function)||!(o instanceof AST_New)&&r.contains_this()))return!0;if(o instanceof AST_Array)return is_modified(t,e,o,o,i+1);if(o instanceof AST_ObjectKeyVal&&n===o.value){var a=e.parent(i+1);return is_modified(t,e,a,a,i+2)}if(o instanceof AST_PropAccess&&o.expression===n){var u=read_property(r,o.property);return!s&&is_modified(t,e,o,u,i+1)}}export function is_used_in_expression(t){for(let e,n,r=-1;e=t.parent(r),n=t.parent(r+1);r++){if(n instanceof AST_Sequence){if(n.expressions.indexOf(e)!==n.expressions.length-1){const e=t.parent(r+2);return!(n.expressions.length>2||1===n.expressions.length||!requires_sequence_to_maintain_binding(e,n,n.expressions[1]))}continue}if(n instanceof AST_Unary){const t=n.operator;if("void"===t)return!1;if("typeof"===t||"+"===t||"-"===t||"!"===t||"~"===t)continue}return!(n instanceof AST_SimpleStatement||n instanceof AST_LabeledStatement)&&!(n instanceof AST_Scope)}return!0}