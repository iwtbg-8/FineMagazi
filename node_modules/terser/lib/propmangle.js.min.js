"use strict";import{defaults,push_uniq,has_annotation,clear_annotation}from"./utils/index.js";import{base54}from"./scope.js";import{AST_Binary,AST_Call,AST_ClassPrivateProperty,AST_Conditional,AST_Dot,AST_DotHash,AST_ObjectKeyVal,AST_ObjectProperty,AST_PrivateMethod,AST_PrivateGetter,AST_PrivateSetter,AST_PrivateIn,AST_Sequence,AST_String,AST_Sub,TreeTransformer,TreeWalker,_KEY,_MANGLEPROP,walk}from"./ast.js";import{domprops}from"../tools/domprops.js";function find_builtins(e){domprops.forEach(r);var t={},n="object"==typeof global?global:self;function r(t){e.add(t)}["Symbol","Map","Promise","Proxy","Reflect","Set","WeakMap","WeakSet"].forEach(function(e){t[e]=n[e]||function(){}}),["null","true","false","NaN","Infinity","-Infinity","undefined"].forEach(r),[Object,Array,Function,Number,String,Boolean,Error,Math,Date,RegExp,t.Symbol,ArrayBuffer,DataView,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,eval,EvalError,Float32Array,Float64Array,Int8Array,Int16Array,Int32Array,isFinite,isNaN,JSON,t.Map,parseFloat,parseInt,t.Promise,t.Proxy,RangeError,ReferenceError,t.Reflect,t.Set,SyntaxError,TypeError,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,URIError,t.WeakMap,t.WeakSet].forEach(function(e){Object.getOwnPropertyNames(e).map(r),e.prototype&&Object.getOwnPropertyNames(e.prototype).map(r)})}function reserve_quoted_keys(e,t){function n(e){push_uniq(t,e)}e.walk(new TreeWalker(function(e){e instanceof AST_ObjectKeyVal&&e.quote?n(e.key):e instanceof AST_ObjectProperty&&e.quote?n(e.key.name):e instanceof AST_Sub&&addStrings(e.property,n)}))}function addStrings(e,t){e.walk(new TreeWalker(function(e){return e instanceof AST_Sequence?addStrings(e.tail_node(),t):e instanceof AST_String?t(e.value):e instanceof AST_Conditional&&(addStrings(e.consequent,t),addStrings(e.alternative,t)),!0}))}function mangle_private_properties(e,t){var n=-1,r=new Map,a=t.nth_identifier||base54;return e=e.transform(new TreeTransformer(function(e){e instanceof AST_ClassPrivateProperty||e instanceof AST_PrivateMethod||e instanceof AST_PrivateGetter||e instanceof AST_PrivateSetter||e instanceof AST_PrivateIn?e.key.name=o(e.key.name):e instanceof AST_DotHash&&(e.property=o(e.property))}));function o(e){let t=r.get(e);return t||(t=a.get(++n),r.set(e,t)),t}}function find_annotated_props(e){var t=new Set;return walk(e,e=>{e instanceof AST_ClassPrivateProperty||e instanceof AST_PrivateMethod||e instanceof AST_PrivateGetter||e instanceof AST_PrivateSetter||e instanceof AST_DotHash||(e instanceof AST_ObjectKeyVal?"string"==typeof e.key&&has_annotation(e,_MANGLEPROP)&&t.add(e.key):e instanceof AST_ObjectProperty?has_annotation(e,_MANGLEPROP)&&t.add(e.key.name):e instanceof AST_Dot?has_annotation(e,_MANGLEPROP)&&t.add(e.property):e instanceof AST_Sub&&e.property instanceof AST_String&&has_annotation(e,_MANGLEPROP)&&t.add(e.property.value))}),t}function mangle_properties(e,t,n=find_annotated_props(e)){var r=(t=defaults(t,{builtins:!1,cache:null,debug:!1,keep_quoted:!1,nth_identifier:base54,only_cache:!1,regex:null,reserved:null,undeclared:!1,only_annotated:!1},!0)).nth_identifier,a=t.reserved;Array.isArray(a)||(a=[a]);var o=new Set(a);t.builtins||find_builtins(o);var i,s=-1;i=t.cache?t.cache.props:new Map;var f,c=t.only_annotated,_=t.regex&&new RegExp(t.regex),p=!1!==t.debug;p&&(f=!0===t.debug?"":t.debug);var S=new Set,l=new Set;i.forEach(e=>l.add(e));var u=!!t.keep_quoted;return e.walk(new TreeWalker(function(e){if(e instanceof AST_ClassPrivateProperty||e instanceof AST_PrivateMethod||e instanceof AST_PrivateGetter||e instanceof AST_PrivateSetter||e instanceof AST_DotHash);else if(e instanceof AST_ObjectKeyVal)"string"!=typeof e.key||u&&e.quote||A(e.key);else if(e instanceof AST_ObjectProperty)u&&e.quote||A(e.key.name);else if(e instanceof AST_Dot){var n=!!t.undeclared;if(!n){for(var r=e;r.expression;)r=r.expression;n=!(r.thedef&&r.thedef.undeclared)}!n||u&&e.quote||A(e.property)}else e instanceof AST_Sub?u||addStrings(e.property,A):e instanceof AST_Call&&"Object.defineProperty"==e.expression.print_to_string()?addStrings(e.args[1],A):e instanceof AST_Binary&&"in"===e.operator?addStrings(e.left,A):e instanceof AST_String&&has_annotation(e,_KEY)&&A(e.value)})),e.transform(new TreeTransformer(function(e){e instanceof AST_ClassPrivateProperty||e instanceof AST_PrivateMethod||e instanceof AST_PrivateGetter||e instanceof AST_PrivateSetter||e instanceof AST_DotHash||(e instanceof AST_ObjectKeyVal?"string"!=typeof e.key||u&&e.quote||(e.key=T(e.key)):e instanceof AST_ObjectProperty?u&&e.quote||e.computed_key()||(e.key.name=T(e.key.name)):e instanceof AST_Dot?u&&e.quote||(e.property=T(e.property)):!u&&e instanceof AST_Sub?e.property=v(e.property):e instanceof AST_Call&&"Object.defineProperty"==e.expression.print_to_string()?e.args[1]=v(e.args[1]):e instanceof AST_Binary&&"in"===e.operator?e.left=v(e.left):e instanceof AST_String&&has_annotation(e,_KEY)&&(clear_annotation(e,_KEY),e.value=T(e.value)))}));function d(e){return!l.has(e)&&(!o.has(e)&&(t.only_cache?i.has(e):!/^-?[0-9]+(\.[0-9]+)?(e[+-][0-9]+)?$/.test(e)))}function y(e){return!(c&&!n.has(e))&&(_&&!_.test(e)?n.has(e):!o.has(e)&&(i.has(e)||S.has(e)))}function A(e){d(e)&&S.add(e),y(e)||l.add(e)}function T(e){if(!y(e))return e;var t=i.get(e);if(!t){if(p){var n="_$"+e+"$"+f+"_";d(n)&&(t=n)}if(!t)do{t=r.get(++s)}while(!d(t));i.set(e,t)}return t}function v(e){return e.transform(new TreeTransformer(function(e){if(e instanceof AST_Sequence){var t=e.expressions.length-1;e.expressions[t]=v(e.expressions[t])}else e instanceof AST_String?(clear_annotation(e,_KEY),e.value=T(e.value)):e instanceof AST_Conditional&&(e.consequent=v(e.consequent),e.alternative=v(e.alternative));return e}))}}export{reserve_quoted_keys,mangle_properties,mangle_private_properties,find_annotated_props};