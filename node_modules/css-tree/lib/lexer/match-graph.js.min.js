import{parse}from"../definition-syntax/parse.js";export const MATCH={type:"Match"};export const MISMATCH={type:"Mismatch"};export const DISALLOW_EMPTY={type:"DisallowEmpty"};const LEFTPARENTHESIS=40,RIGHTPARENTHESIS=41;function createCondition(e,t,n){return t===MATCH&&n===MISMATCH||e===MATCH&&t===MATCH&&n===MATCH?e:("If"===e.type&&e.else===MISMATCH&&t===MATCH&&(t=e.then,e=e.match),{type:"If",match:e,then:t,else:n})}function isFunctionType(e){return e.length>2&&40===e.charCodeAt(e.length-2)&&41===e.charCodeAt(e.length-1)}function isEnumCapatible(e){return"Keyword"===e.type||"AtKeyword"===e.type||"Function"===e.type||"Type"===e.type&&isFunctionType(e.name)}function buildGroupMatchGraph(e,t,n){switch(e){case" ":{let e=MATCH;for(let n=t.length-1;n>=0;n--){e=createCondition(t[n],e,MISMATCH)}return e}case"|":{let e=MISMATCH,n=null;for(let a=t.length-1;a>=0;a--){let r=t[a];if(isEnumCapatible(r)&&(null===n&&a>0&&isEnumCapatible(t[a-1])&&(n=Object.create(null),e=createCondition({type:"Enum",map:n},MATCH,e)),null!==n)){const e=(isFunctionType(r.name)?r.name.slice(0,-1):r.name).toLowerCase();if(e in n==!1){n[e]=r;continue}}n=null,e=createCondition(r,MATCH,e)}return e}case"&&":{if(t.length>5)return{type:"MatchOnce",terms:t,all:!0};let n=MISMATCH;for(let a=t.length-1;a>=0;a--){const r=t[a];let o;o=t.length>1?buildGroupMatchGraph(e,t.filter(function(e){return e!==r}),!1):MATCH,n=createCondition(r,o,n)}return n}case"||":{if(t.length>5)return{type:"MatchOnce",terms:t,all:!1};let a=n?MATCH:MISMATCH;for(let n=t.length-1;n>=0;n--){const r=t[n];let o;o=t.length>1?buildGroupMatchGraph(e,t.filter(function(e){return e!==r}),!0):MATCH,a=createCondition(r,o,a)}return a}}}function buildMultiplierMatchGraph(e){let t=MATCH,n=buildMatchGraphInternal(e.term);if(0===e.max)n=createCondition(n,DISALLOW_EMPTY,MISMATCH),t=createCondition(n,null,MISMATCH),t.then=createCondition(MATCH,MATCH,t),e.comma&&(t.then.else=createCondition({type:"Comma",syntax:e},t,MISMATCH));else for(let a=e.min||1;a<=e.max;a++)e.comma&&t!==MATCH&&(t=createCondition({type:"Comma",syntax:e},t,MISMATCH)),t=createCondition(n,createCondition(MATCH,MATCH,t),MISMATCH);if(0===e.min)t=createCondition(MATCH,MATCH,t);else for(let a=0;a<e.min-1;a++)e.comma&&t!==MATCH&&(t=createCondition({type:"Comma",syntax:e},t,MISMATCH)),t=createCondition(n,t,MISMATCH);return t}function buildMatchGraphInternal(e){if("function"==typeof e)return{type:"Generic",fn:e};switch(e.type){case"Group":{let t=buildGroupMatchGraph(e.combinator,e.terms.map(buildMatchGraphInternal),!1);return e.disallowEmpty&&(t=createCondition(t,DISALLOW_EMPTY,MISMATCH)),t}case"Multiplier":return buildMultiplierMatchGraph(e);case"Type":case"Property":return{type:e.type,name:e.name,syntax:e};case"Keyword":return{type:e.type,name:e.name.toLowerCase(),syntax:e};case"AtKeyword":return{type:e.type,name:"@"+e.name.toLowerCase(),syntax:e};case"Function":return{type:e.type,name:e.name.toLowerCase()+"(",syntax:e};case"String":return 3===e.value.length?{type:"Token",value:e.value.charAt(1),syntax:e}:{type:e.type,value:e.value.substr(1,e.value.length-2).replace(/\\'/g,"'"),syntax:e};case"Token":return{type:e.type,value:e.value,syntax:e};case"Comma":return{type:e.type,syntax:e};default:throw new Error("Unknown node type:",e.type)}}export function buildMatchGraph(e,t){return"string"==typeof e&&(e=parse(e)),{type:"MatchGraph",match:buildMatchGraphInternal(e),syntax:t||null,source:e}}