import{Tokenizer}from"./tokenizer.js";const TAB=9,N=10,F=12,R=13,SPACE=32,EXCLAMATIONMARK=33,NUMBERSIGN=35,AMPERSAND=38,APOSTROPHE=39,LEFTPARENTHESIS=40,RIGHTPARENTHESIS=41,ASTERISK=42,PLUSSIGN=43,COMMA=44,HYPERMINUS=45,LESSTHANSIGN=60,GREATERTHANSIGN=62,QUESTIONMARK=63,COMMERCIALAT=64,LEFTSQUAREBRACKET=91,RIGHTSQUAREBRACKET=93,LEFTCURLYBRACKET=123,VERTICALLINE=124,RIGHTCURLYBRACKET=125,INFINITY=8734,NAME_CHAR=new Uint8Array(128).map((e,r)=>/[a-zA-Z0-9\-]/.test(String.fromCharCode(r))?1:0),COMBINATOR_PRECEDENCE={" ":1,"&&":2,"||":3,"|":4};function scanSpaces(e){return e.substringToPos(e.findWsEnd(e.pos))}function scanWord(e){let r=e.pos;for(;r<e.str.length;r++){const t=e.str.charCodeAt(r);if(t>=128||0===NAME_CHAR[t])break}return e.pos===r&&e.error("Expect a keyword"),e.substringToPos(r)}function scanNumber(e){let r=e.pos;for(;r<e.str.length;r++){const t=e.str.charCodeAt(r);if(t<48||t>57)break}return e.pos===r&&e.error("Expect a number"),e.substringToPos(r)}function scanString(e){const r=e.str.indexOf("'",e.pos+1);return-1===r&&(e.pos=e.str.length,e.error("Expect an apostrophe")),e.substringToPos(r+1)}function readMultiplierRange(e){let r=null,t=null;return e.eat(123),r=scanNumber(e),44===e.charCode()?(e.pos++,125!==e.charCode()&&(t=scanNumber(e))):t=r,e.eat(125),{min:Number(r),max:t?Number(t):0}}function readMultiplier(e){let r=null,t=!1;switch(e.charCode()){case 42:e.pos++,r={min:0,max:0};break;case 43:e.pos++,r={min:1,max:0};break;case 63:e.pos++,r={min:0,max:1};break;case 35:e.pos++,t=!0,123===e.charCode()?r=readMultiplierRange(e):63===e.charCode()?(e.pos++,r={min:0,max:0}):r={min:1,max:0};break;case 123:r=readMultiplierRange(e);break;default:return null}return{type:"Multiplier",comma:t,min:r.min,max:r.max,term:null}}function maybeMultiplied(e,r){const t=readMultiplier(e);return null!==t?(t.term=r,35===e.charCode()&&43===e.charCodeAt(e.pos-1)?maybeMultiplied(e,t):t):r}function maybeToken(e){const r=e.peek();return""===r?null:{type:"Token",value:r}}function readProperty(e){let r;return e.eat(60),e.eat(39),r=scanWord(e),e.eat(39),e.eat(62),maybeMultiplied(e,{type:"Property",name:r})}function readTypeRange(e){let r=null,t=null,n=1;return e.eat(91),45===e.charCode()&&(e.peek(),n=-1),-1==n&&8734===e.charCode()?e.peek():(r=n*Number(scanNumber(e)),0!==NAME_CHAR[e.charCode()]&&(r+=scanWord(e))),scanSpaces(e),e.eat(44),scanSpaces(e),8734===e.charCode()?e.peek():(n=1,45===e.charCode()&&(e.peek(),n=-1),t=n*Number(scanNumber(e)),0!==NAME_CHAR[e.charCode()]&&(t+=scanWord(e))),e.eat(93),{type:"Range",min:r,max:t}}function readType(e){let r,t=null;return e.eat(60),r=scanWord(e),40===e.charCode()&&41===e.nextCharCode()&&(e.pos+=2,r+="()"),91===e.charCodeAt(e.findWsEnd(e.pos))&&(scanSpaces(e),t=readTypeRange(e)),e.eat(62),maybeMultiplied(e,{type:"Type",name:r,opts:t})}function readKeywordOrFunction(e){const r=scanWord(e);return 40===e.charCode()?(e.pos++,{type:"Function",name:r}):maybeMultiplied(e,{type:"Keyword",name:r})}function regroupTerms(e,r){function t(e,r){return{type:"Group",terms:e,combinator:r,disallowEmpty:!1,explicit:!1}}let n;for(r=Object.keys(r).sort((e,r)=>COMBINATOR_PRECEDENCE[e]-COMBINATOR_PRECEDENCE[r]);r.length>0;){n=r.shift();let a=0,o=0;for(;a<e.length;a++){const r=e[a];"Combinator"===r.type&&(r.value===n?(-1===o&&(o=a-1),e.splice(a,1),a--):(-1!==o&&a-o>1&&(e.splice(o,a-o,t(e.slice(o,a),n)),a=o+1),o=-1))}-1!==o&&r.length&&e.splice(o,a-o,t(e.slice(o,a),n))}return n}function readImplicitGroup(e){const r=[],t={};let n,a=null,o=e.pos;for(;n=peek(e);)"Spaces"!==n.type&&("Combinator"===n.type?(null!==a&&"Combinator"!==a.type||(e.pos=o,e.error("Unexpected combinator")),t[n.value]=!0):null!==a&&"Combinator"!==a.type&&(t[" "]=!0,r.push({type:"Combinator",value:" "})),r.push(n),a=n,o=e.pos);return null!==a&&"Combinator"===a.type&&(e.pos-=o,e.error("Unexpected combinator")),{type:"Group",terms:r,combinator:regroupTerms(r,t)||" ",disallowEmpty:!1,explicit:!1}}function readGroup(e){let r;return e.eat(91),r=readImplicitGroup(e),e.eat(93),r.explicit=!0,33===e.charCode()&&(e.pos++,r.disallowEmpty=!0),r}function peek(e){let r=e.charCode();if(r<128&&1===NAME_CHAR[r])return readKeywordOrFunction(e);switch(r){case 93:break;case 91:return maybeMultiplied(e,readGroup(e));case 60:return 39===e.nextCharCode()?readProperty(e):readType(e);case 124:return{type:"Combinator",value:e.substringToPos(e.pos+(124===e.nextCharCode()?2:1))};case 38:return e.pos++,e.eat(38),{type:"Combinator",value:"&&"};case 44:return e.pos++,{type:"Comma"};case 39:return maybeMultiplied(e,{type:"String",value:scanString(e)});case 32:case 9:case N:case R:case F:return{type:"Spaces",value:scanSpaces(e)};case 64:return r=e.nextCharCode(),r<128&&1===NAME_CHAR[r]?(e.pos++,{type:"AtKeyword",name:scanWord(e)}):maybeToken(e);case 42:case 43:case 63:case 35:case 33:break;case 123:if(r=e.nextCharCode(),r<48||r>57)return maybeToken(e);break;default:return maybeToken(e)}}export function parse(e){const r=new Tokenizer(e),t=readImplicitGroup(r);return r.pos!==e.length&&r.error("Unexpected input"),1===t.terms.length&&"Group"===t.terms[0].type?t.terms[0]:t}