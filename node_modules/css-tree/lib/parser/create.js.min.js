import{List}from"../utils/List.js";import{SyntaxError}from"./SyntaxError.js";import{tokenize,OffsetToLocation,TokenStream,tokenNames,consumeNumber,findWhiteSpaceStart,cmpChar,cmpStr,WhiteSpace,Comment,Ident,Function as FunctionToken,Url,Hash,Percentage,Number as NumberToken}from"../tokenizer/index.js";import{readSequence}from"./sequence.js";const NOOP=()=>{},EXCLAMATIONMARK=33,NUMBERSIGN=35,SEMICOLON=59,LEFTCURLYBRACKET=123,NULL=0;function createParseContext(e){return function(){return this[e]()}}function fetchParseValues(e){const t=Object.create(null);for(const n in e){const r=e[n],o=r.parse||r;o&&(t[n]=o)}return t}function processConfig(e){const t={context:Object.create(null),scope:Object.assign(Object.create(null),e.scope),atrule:fetchParseValues(e.atrule),pseudo:fetchParseValues(e.pseudo),node:fetchParseValues(e.node)};for(const n in e.parseContext)switch(typeof e.parseContext[n]){case"function":t.context[n]=e.parseContext[n];break;case"string":t.context[n]=createParseContext(e.parseContext[n])}return{config:t,...t,...t.node}}export function createParser(e){let t="",n="<unknown>",r=!1,o=NOOP,s=!1;const i=new OffsetToLocation,a=Object.assign(new TokenStream,processConfig(e||{}),{parseAtrulePrelude:!0,parseRulePrelude:!0,parseValue:!0,parseCustomProperty:!1,readSequence:readSequence,consumeUntilBalanceEnd:()=>0,consumeUntilLeftCurlyBracket:e=>123===e?1:0,consumeUntilLeftCurlyBracketOrSemicolon:e=>123===e||59===e?1:0,consumeUntilExclamationMarkOrSemicolon:e=>33===e||59===e?1:0,consumeUntilSemicolonIncluded:e=>59===e?2:0,createList:()=>new List,createSingleNodeList:e=>(new List).appendData(e),getFirstListNode:e=>e&&e.first,getLastListNode:e=>e&&e.last,parseWithFallback(e,t){const n=this.tokenIndex;try{return e.call(this)}catch(e){if(s)throw e;const r=t.call(this,n);return s=!0,o(e,r),s=!1,r}},lookupNonWSType(e){let t;do{if(t=this.lookupType(e++),t!==WhiteSpace)return t}while(0!==t);return 0},charCodeAt:e=>e>=0&&e<t.length?t.charCodeAt(e):0,substring:(e,n)=>t.substring(e,n),substrToCursor(e){return this.source.substring(e,this.tokenStart)},cmpChar:(e,n)=>cmpChar(t,e,n),cmpStr:(e,n,r)=>cmpStr(t,e,n,r),consume(e){const t=this.tokenStart;return this.eat(e),this.substrToCursor(t)},consumeFunctionName(){const e=t.substring(this.tokenStart,this.tokenEnd-1);return this.eat(FunctionToken),e},consumeNumber(e){const n=t.substring(this.tokenStart,consumeNumber(t,this.tokenStart));return this.eat(e),n},eat(e){if(this.tokenType!==e){const t=tokenNames[e].slice(0,-6).replace(/-/g," ").replace(/^./,e=>e.toUpperCase());let n=`${/[[\](){}]/.test(t)?`"${t}"`:t} is expected`,r=this.tokenStart;switch(e){case Ident:this.tokenType===FunctionToken||this.tokenType===Url?(r=this.tokenEnd-1,n="Identifier is expected but function found"):n="Identifier is expected";break;case Hash:this.isDelim(35)&&(this.next(),r++,n="Name is expected");break;case Percentage:this.tokenType===NumberToken&&(r=this.tokenEnd,n="Percent sign is expected")}this.error(n,r)}this.next()},eatIdent(e){this.tokenType===Ident&&!1!==this.lookupValue(0,e)||this.error(`Identifier "${e}" is expected`),this.next()},eatDelim(e){this.isDelim(e)||this.error(`Delim "${String.fromCharCode(e)}" is expected`),this.next()},getLocation:(e,t)=>r?i.getLocationRange(e,t,n):null,getLocationFromList(e){if(r){const t=this.getFirstListNode(e),r=this.getLastListNode(e);return i.getLocationRange(null!==t?t.loc.start.offset-i.startOffset:this.tokenStart,null!==r?r.loc.end.offset-i.startOffset:this.tokenStart,n)}return null},error(e,n){const r=void 0!==n&&n<t.length?i.getLocation(n):this.eof?i.getLocation(findWhiteSpaceStart(t,t.length-1)):i.getLocation(this.tokenStart);throw new SyntaxError(e||"Unexpected input",t,r.offset,r.line,r.column)}});return Object.assign(function(e,c){t=e,c=c||{},a.setSource(t,tokenize),i.setSource(t,c.offset,c.line,c.column),n=c.filename||"<unknown>",r=Boolean(c.positions),o="function"==typeof c.onParseError?c.onParseError:NOOP,s=!1,a.parseAtrulePrelude=!("parseAtrulePrelude"in c)||Boolean(c.parseAtrulePrelude),a.parseRulePrelude=!("parseRulePrelude"in c)||Boolean(c.parseRulePrelude),a.parseValue=!("parseValue"in c)||Boolean(c.parseValue),a.parseCustomProperty="parseCustomProperty"in c&&Boolean(c.parseCustomProperty);const{context:u="default",onComment:l}=c;if(u in a.context==!1)throw new Error("Unknown context `"+u+"`");"function"==typeof l&&a.forEachToken((e,n,r)=>{if(e===Comment){const e=a.getLocation(n,r),o=cmpStr(t,r-2,r,"*/")?t.slice(n+2,r-2):t.slice(n+2,r);l(o,e)}});const p=a.context[u].call(a,c);return a.eof||a.error(),p},{SyntaxError:SyntaxError,config:a.config})}