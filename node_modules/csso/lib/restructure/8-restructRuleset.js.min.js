import{List,walk}from"css-tree";import{unsafeToSkipNode,isEqualSelectors,compareDeclarations,addSelectors}from"./utils.js";function calcSelectorLength(e){return e.reduce((e,r)=>e+r.id.length+1,0)-1}function calcDeclarationsLength(e){let r=0;for(const l of e)r+=l.length;return r+e.length-1}function processRule(e,r,l){const n=null!==this.block&&this.block.avoidRulesMerge,t=e.prelude.children,c=e.block,o=Object.create(null);let i=!0,a=!0;l.prevUntil(r.prev,function(s,u){const d=s.block,h=s.type;if("Rule"!==h){const e=unsafeToSkipNode.call(t,s);return!e&&"Atrule"===h&&d&&walk(d,{visit:"Rule",enter(e){e.prelude.children.forEach(e=>{o[e.compareMarker]=!0})}}),e}if(e.pseudoSignature!==s.pseudoSignature)return!0;const p=s.prelude.children;if(a=!p.some(e=>e.compareMarker in o),!a&&!i)return!0;if(i&&isEqualSelectors(p,t))return d.children.appendList(c.children),l.remove(r),!0;const f=compareDeclarations(c.children,d.children);if(f.eq.length){if(!f.ne1.length&&!f.ne2.length)return a&&(addSelectors(t,p),l.remove(u)),!0;if(!n)if(f.ne1.length&&!f.ne2.length){const e=calcSelectorLength(t),r=calcDeclarationsLength(f.eq);i&&e<r&&(addSelectors(p,t),c.children.fromArray(f.ne1))}else if(!f.ne1.length&&f.ne2.length){const e=calcSelectorLength(p),r=calcDeclarationsLength(f.eq);a&&e<r&&(addSelectors(t,p),d.children.fromArray(f.ne2))}else{const n={type:"SelectorList",loc:null,children:addSelectors(p.copy(),t)},o=calcSelectorLength(n.children)+2;if(calcDeclarationsLength(f.eq)>=o){const t=l.createItem({type:"Rule",loc:null,prelude:n,block:{type:"Block",loc:null,children:(new List).fromArray(f.eq)},pseudoSignature:e.pseudoSignature});return c.children.fromArray(f.ne1),d.children.fromArray(f.ne2overrided),i?l.insert(t,u):l.insert(t,r),!0}}}i&&(i=!p.some(e=>t.some(r=>r.compareMarker===e.compareMarker))),p.forEach(e=>{o[e.compareMarker]=!0})})}export default function restructRule(e){walk(e,{visit:"Rule",reverse:!0,enter:processRule})}