import{walk,generate,property as resolveProperty,keyword as resolveKeyword}from"css-tree";let fingerprintId=1;const dontRestructure=new Set(["src"]),DONT_MIX_VALUE={display:/table|ruby|flex|-(flex)?box$|grid|contents|run-in/i,"text-align":/^(start|end|match-parent|justify-all)$/i},SAFE_VALUES={cursor:["auto","crosshair","default","move","text","wait","help","n-resize","e-resize","s-resize","w-resize","ne-resize","nw-resize","se-resize","sw-resize","pointer","progress","not-allowed","no-drop","vertical-text","all-scroll","col-resize","row-resize"],overflow:["hidden","visible","scroll","auto"],position:["static","relative","absolute","fixed"]},NEEDLESS_TABLE={"border-width":["border"],"border-style":["border"],"border-color":["border"],"border-top":["border"],"border-right":["border"],"border-bottom":["border"],"border-left":["border"],"border-top-width":["border-top","border-width","border"],"border-right-width":["border-right","border-width","border"],"border-bottom-width":["border-bottom","border-width","border"],"border-left-width":["border-left","border-width","border"],"border-top-style":["border-top","border-style","border"],"border-right-style":["border-right","border-style","border"],"border-bottom-style":["border-bottom","border-style","border"],"border-left-style":["border-left","border-style","border"],"border-top-color":["border-top","border-color","border"],"border-right-color":["border-right","border-color","border"],"border-bottom-color":["border-bottom","border-color","border"],"border-left-color":["border-left","border-color","border"],"margin-top":["margin"],"margin-right":["margin"],"margin-bottom":["margin"],"margin-left":["margin"],"padding-top":["padding"],"padding-right":["padding"],"padding-bottom":["padding"],"padding-left":["padding"],"font-style":["font"],"font-variant":["font"],"font-weight":["font"],"font-size":["font"],"font-family":["font"],"list-style-type":["list-style"],"list-style-position":["list-style"],"list-style-image":["list-style"]};function getPropertyFingerprint(e,r,t){const o=resolveProperty(e).basename;if("background"===o)return e+":"+generate(r.value);const i=r.id;let s=t[i];if(!s){switch(r.value.type){case"Value":const e={};let t="",i="",d=!1;r.value.children.forEach(function r(s){switch(s.type){case"Value":case"Brackets":case"Parentheses":s.children.forEach(r);break;case"Raw":d=!0;break;case"Identifier":{const{name:r}=s;t||(t=resolveKeyword(r).vendor),/\\[09]/.test(r)&&(i=RegExp.lastMatch),SAFE_VALUES.hasOwnProperty(o)?-1===SAFE_VALUES[o].indexOf(r)&&(e[r]=!0):DONT_MIX_VALUE.hasOwnProperty(o)&&DONT_MIX_VALUE[o].test(r)&&(e[r]=!0);break}case"Function":{let{name:o}=s;if(t||(t=resolveKeyword(o).vendor),"rect"===o){s.children.some(e=>"Operator"===e.type&&","===e.value)||(o="rect-backward")}e[o+"()"]=!0,s.children.forEach(r);break}case"Dimension":{const{unit:r}=s;switch(/\\[09]/.test(r)&&(i=RegExp.lastMatch),r){case"rem":case"vw":case"vh":case"vmin":case"vmax":case"vm":e[r]=!0}break}}}),s=d?"!"+fingerprintId++:"!"+Object.keys(e).sort()+"|"+i+t;break;case"Raw":s="!"+r.value.value;break;default:s=generate(r.value)}t[i]=s}return e+s}function needless(e,r,t){const o=resolveProperty(r.property);if(NEEDLESS_TABLE.hasOwnProperty(o.basename)){const i=NEEDLESS_TABLE[o.basename];for(const s of i){const i=getPropertyFingerprint(o.prefix+s,r,t),d=e.hasOwnProperty(i)?e[i]:null;if(d&&(!r.important||d.item.data.important))return d}}}function processRule(e,r,t,o,i){const s=e.block.children;s.forEachRight(function(e,r){const{property:t}=e,d=getPropertyFingerprint(t,e,i),n=o[d];if(n&&!dontRestructure.has(t))e.important&&!n.item.data.important?(o[d]={block:s,item:r},n.block.remove(n.item)):s.remove(r);else{needless(o,e,i)?s.remove(r):(e.fingerprint=d,o[d]={block:s,item:r})}}),s.isEmpty&&t.remove(r)}export default function restructBlock(e){const r={},t=Object.create(null);walk(e,{visit:"Rule",reverse:!0,enter(e,o,i){const s=this.block||this.stylesheet,d=(e.pseudoSignature||"")+"|"+e.prelude.children.first.id;let n,a;r.hasOwnProperty(s.id)?n=r[s.id]:(n={},r[s.id]=n),n.hasOwnProperty(d)?a=n[d]:(a={},n[d]=a),processRule.call(this,e,o,i,a,t)}})}