import{List,generate,walk}from"css-tree";const REPLACE=1,REMOVE=2,TOP=0,RIGHT=1,BOTTOM=2,LEFT=3,SIDES=["top","right","bottom","left"],SIDE={"margin-top":"top","margin-right":"right","margin-bottom":"bottom","margin-left":"left","padding-top":"top","padding-right":"right","padding-bottom":"bottom","padding-left":"left","border-top-color":"top","border-right-color":"right","border-bottom-color":"bottom","border-left-color":"left","border-top-width":"top","border-right-width":"right","border-bottom-width":"bottom","border-left-width":"left","border-top-style":"top","border-right-style":"right","border-bottom-style":"bottom","border-left-style":"left"},MAIN_PROPERTY={margin:"margin","margin-top":"margin","margin-right":"margin","margin-bottom":"margin","margin-left":"margin",padding:"padding","padding-top":"padding","padding-right":"padding","padding-bottom":"padding","padding-left":"padding","border-color":"border-color","border-top-color":"border-color","border-right-color":"border-color","border-bottom-color":"border-color","border-left-color":"border-color","border-width":"border-width","border-top-width":"border-width","border-right-width":"border-width","border-bottom-width":"border-width","border-left-width":"border-width","border-style":"border-style","border-top-style":"border-style","border-right-style":"border-style","border-bottom-style":"border-style","border-left-style":"border-style"};class TRBL{constructor(t){this.name=t,this.loc=null,this.iehack=void 0,this.sides={top:null,right:null,bottom:null,left:null}}getValueSequence(t,e){const r=[];let o="";return!("Value"!==t.value.type||t.value.children.some(function(e){let i=!1;switch(e.type){case"Identifier":switch(e.name){case"\\0":case"\\9":return void(o=e.name);case"inherit":case"initial":case"unset":case"revert":i=e.name}break;case"Dimension":switch(e.unit){case"rem":case"vw":case"vh":case"vmin":case"vmax":case"vm":i=e.unit}break;case"Hash":case"Number":case"Percentage":break;case"Function":if("var"===e.name)return!0;i=e.name;break;default:return!0}r.push({node:e,special:i,important:t.important})})||r.length>e)&&(("string"!=typeof this.iehack||this.iehack===o)&&(this.iehack=o,r))}canOverride(t,e){const r=this.sides[t];return!r||e.important&&!r.important}add(t,e){return!!function(){const r=this.sides,o=SIDE[t];if(o){if(o in r==!1)return!1;const t=this.getValueSequence(e,1);if(!t||!t.length)return!1;for(const e in r)if(null!==r[e]&&r[e].special!==t[0].special)return!1;return!this.canOverride(o,t[0])||(r[o]=t[0],!0)}if(t===this.name){const t=this.getValueSequence(e,4);if(!t||!t.length)return!1;switch(t.length){case 1:t[1]=t[0],t[2]=t[0],t[3]=t[0];break;case 2:t[2]=t[0],t[3]=t[1];break;case 3:t[3]=t[1]}for(let e=0;e<4;e++)for(const o in r)if(null!==r[o]&&r[o].special!==t[e].special)return!1;for(let e=0;e<4;e++)this.canOverride(SIDES[e],t[e])&&(r[SIDES[e]]=t[e]);return!0}}.call(this)&&(this.loc||(this.loc=e.loc),!0)}isOkToMinimize(){const t=this.sides.top,e=this.sides.right,r=this.sides.bottom,o=this.sides.left;if(t&&e&&r&&o){const i=t.important+e.important+r.important+o.important;return 0===i||4===i}return!1}getValue(){const t=new List,e=this.sides,r=[e.top,e.right,e.bottom,e.left],o=[generate(e.top.node),generate(e.right.node),generate(e.bottom.node),generate(e.left.node)];o[3]===o[1]&&(r.pop(),o[2]===o[0]&&(r.pop(),o[1]===o[0]&&r.pop()));for(let e=0;e<r.length;e++)t.appendData(r[e].node);return this.iehack&&t.appendData({type:"Identifier",loc:null,name:this.iehack}),{type:"Value",loc:null,children:t}}getDeclaration(){return{type:"Declaration",loc:this.loc,important:this.sides.top.important,property:this.name,value:this.getValue()}}}function processRule(t,e,r,o){const i=t.block.children,n=t.prelude.children.first.id;return t.block.children.forEachRight(function(t,s){const a=t.property;if(!MAIN_PROPERTY.hasOwnProperty(a))return;const l=MAIN_PROPERTY[a];let d,c;o&&n!==o||l in e&&(c=2,d=e[l]),d&&d.add(a,t)||(c=1,d=new TRBL(l),d.add(a,t))?(e[l]=d,r.push({operation:c,block:i,item:s,shorthand:d}),o=n):o=null}),o}function processShorthands(t,e){t.forEach(function(t){const r=t.shorthand;r.isOkToMinimize()&&(1===t.operation?t.item.data=e(r.getDeclaration()):t.block.remove(t.item))})}export default function restructBlock(t,e){const r={},o=[];walk(t,{visit:"Rule",reverse:!0,enter(t){const e=this.block||this.stylesheet,i=(t.pseudoSignature||"")+"|"+t.prelude.children.first.id;let n,s;r.hasOwnProperty(e.id)?n=r[e.id]:(n={lastShortSelector:null},r[e.id]=n),n.hasOwnProperty(i)?s=n[i]:(s={},n[i]=s),n.lastShortSelector=processRule.call(this,t,s,o,n.lastShortSelector)}}),processShorthands(o,e.declaration)}