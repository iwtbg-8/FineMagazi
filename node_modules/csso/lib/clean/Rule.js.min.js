import{walk,keyword}from"css-tree";import{hasNoChildren}from"./utils.js";const{hasOwnProperty:hasOwnProperty}=Object.prototype,skipUsageFilteringAtrule=new Set(["keyframes"]);function cleanUnused(e,l){return e.children.forEach((t,s,a)=>{let n=!1;walk(t,function(t){if(null===this.selector||this.selector===e)switch(t.type){case"SelectorList":null!==this.function&&"not"===this.function.name.toLowerCase()||cleanUnused(t,l)&&(n=!0);break;case"ClassSelector":null===l.whitelist||null===l.whitelist.classes||hasOwnProperty.call(l.whitelist.classes,t.name)||(n=!0),null!==l.blacklist&&null!==l.blacklist.classes&&hasOwnProperty.call(l.blacklist.classes,t.name)&&(n=!0);break;case"IdSelector":null===l.whitelist||null===l.whitelist.ids||hasOwnProperty.call(l.whitelist.ids,t.name)||(n=!0),null!==l.blacklist&&null!==l.blacklist.ids&&hasOwnProperty.call(l.blacklist.ids,t.name)&&(n=!0);break;case"TypeSelector":"*"!==t.name.charAt(t.name.length-1)&&(null===l.whitelist||null===l.whitelist.tags||hasOwnProperty.call(l.whitelist.tags,t.name.toLowerCase())||(n=!0),null!==l.blacklist&&null!==l.blacklist.tags&&hasOwnProperty.call(l.blacklist.tags,t.name.toLowerCase())&&(n=!0))}}),n&&a.remove(s)}),e.children.isEmpty}export default function cleanRule(e,l,t,s){if(hasNoChildren(e.prelude)||hasNoChildren(e.block))return void t.remove(l);if(this.atrule&&skipUsageFilteringAtrule.has(keyword(this.atrule.name).basename))return;const{usage:a}=s;!a||null===a.whitelist&&null===a.blacklist||(cleanUnused(e.prelude,a),!hasNoChildren(e.prelude))||t.remove(l)}